<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Trade Tracker & Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the Equity Curve visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .card { background-color: #161b22; border: 1px solid #30363d; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .kpi-value { font-size: 1.5rem; line-height: 1.75rem; font-weight: 700; } /* Slightly smaller font to fit more KPIs */
        .kpi-title { font-size: 0.8rem; }
        .green-text { color: #3fb950; }
        .red-text { color: #f85149; }
        .data-row:nth-child(even) { background-color: #1e242b; }
        /* Scrollbar styles for dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #484f58; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5c6370; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold mb-6 text-white border-b border-[#30363d] pb-3">Trade Performance Dashboard & Journal</h1>

        <!-- Connection Notice -->
        <div class="card p-4 mb-6 rounded-lg text-sm bg-yellow-900/30 border-yellow-700/50">
            <p class="font-semibold text-yellow-300">‚ö†Ô∏è Interactive Brokers Data Strategy:</p>
            <p class="text-yellow-400">Direct API connection requires a secure backend server. This app supports **Bulk Import** by allowing you to paste trade history from an IBKR Flex Report (or any CSV/text file) for instant analysis.</p>
        </div>

        <!-- Chart and Advanced KPIs -->
        <!-- *** ADDED ID="main-content-grid" HERE FOR RELIABLE JS ACCESS *** -->
        <div id="main-content-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Equity Curve Chart -->
            <div class="card p-5 rounded-lg lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4 text-white">Equity Curve (Cumulative P&L)</h2>
                <div class="h-64 md:h-80">
                    <canvas id="equity-curve-chart"></canvas>
                </div>
            </div>

            <!-- Key Performance Indicators (KPIs) -->
            <div class="card p-5 rounded-lg lg:col-span-1">
                <h2 class="text-xl font-semibold mb-4 text-white">Core Metrics</h2>
                <div id="kpi-container" class="grid grid-cols-2 gap-4">
                    <!-- KPIs will be rendered here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Trade Log and Controls -->
        <div class="card p-6 rounded-lg">
            <h2 class="text-2xl font-semibold mb-4 text-white">Trade Log & Journal</h2>

            <!-- Controls (Filter and Buttons) -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div class="w-full sm:w-auto">
                    <label for="symbol-filter" class="block text-sm font-medium mb-1">Filter by Symbol:</label>
                    <select id="symbol-filter" class="w-full sm:w-48 p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white focus:ring-blue-500 focus:border-blue-500">
                        <option value="ALL">ALL SYMBOLS</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button id="import-data-btn" class="w-full sm:w-auto bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        üìÑ Import Bulk Data
                    </button>
                    <button id="add-trade-btn" class="w-full sm:w-auto bg-[#3fb950] hover:bg-[#289d3a] text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        + Add New Trade
                    </button>
                </div>
            </div>

            <!-- Trade Table -->
            <div class="overflow-x-auto rounded-lg border border-[#30363d]">
                <table id="trade-table" class="min-w-full divide-y divide-[#30363d]">
                    <thead class="bg-[#21262d]">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Symbol</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Net P&L ($)</th> <!-- Renamed P&L column -->
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Fee ($)</th> <!-- NEW FEE COLUMN -->
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Notes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="trade-log-body" class="divide-y divide-[#30363d] text-sm">
                        <!-- Trade rows populated by JS -->
                    </tbody>
                </table>
            </div>

            <div id="no-trades-message" class="hidden text-center py-8 text-lg text-gray-500">No trades found for this filter.</div>
        </div>
    </div>

    <!-- Modal for Single Trade Entry/Editing (Hidden by default) -->
    <div id="trade-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg p-6 rounded-xl">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-white">Add New Trade</h3>
            <form id="trade-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Row 1 -->
                    <div>
                        <label for="trade-date" class="block text-sm font-medium mb-1">Date Closed</label>
                        <input type="date" id="trade-date" required class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white">
                    </div>
                    <div>
                        <label for="trade-symbol" class="block text-sm font-medium mb-1">Symbol (e.g., AAPL)</label>
                        <input type="text" id="trade-symbol" required class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white uppercase" maxlength="10">
                    </div>
                    <!-- Row 2 -->
                    <div>
                        <label for="trade-gross-pnl" class="block text-sm font-medium mb-1">Gross P&L ($)</label>
                        <input type="number" step="0.01" id="trade-gross-pnl" required class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white">
                    </div>
                    <div>
                        <label for="trade-size" class="block text-sm font-medium mb-1">Position Size (Shares/Contracts)</label>
                        <input type="number" step="1" id="trade-size" required class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white">
                    </div>
                    <!-- Row 3 (Commission Fee) -->
                    <div class="md:col-span-2">
                        <label for="trade-fee" class="block text-sm font-medium mb-1">Commission Fee ($)</label>
                        <input type="number" step="0.01" id="trade-fee" value="0.00" class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white">
                    </div>
                </div>
                <!-- Journaling Field -->
                <div>
                    <label for="trade-notes" class="block text-sm font-medium mb-1">Journal/Notes (Strategy, Emotion, Setup)</label>
                    <textarea id="trade-notes" rows="3" class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white resize-none"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-trade-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="save-trade-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Save Trade
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Bulk Data Import (Hidden by default) -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 text-white">Import Trades from Flex Report (CSV)</h3>
            <p class="text-sm text-gray-400 mb-4">Paste your trade data below. Each line should follow the format: <code class="bg-[#30363d] p-1 rounded">YYYY-MM-DD,SYMBOL,Gross PnL,Size,Fee</code></p>
            <form id="import-form" class="space-y-4">
                <textarea id="import-data-textarea" rows="10" placeholder="Example: 
2025-10-16,NVDA,150.25,10,1.00
2025-10-16,AMD,-40.50,20,0.80
2025-10-15,TSLA,800.00,5,2.00" 
class="w-full p-3 rounded-lg bg-[#0d1117] border border-[#30363d] text-white resize-none"></textarea>

                <div id="import-status" class="text-sm font-medium text-red-400"></div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-import-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="process-import-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Process & Save Trades
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for Updating Equity (Hidden by default) -->
    <div id="equity-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-sm p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4 text-white">Update Current Equity</h3>
            <form id="equity-form" class="space-y-4">
                <div>
                    <label for="current-equity" class="block text-sm font-medium mb-1">Current Account Balance ($)</label>
                    <input type="number" step="0.01" id="current-equity" required class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-equity-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="save-equity-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Save Balance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, serverTimestamp, setLogLevel, writeBatch, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to debug for better visibility in the console
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES & FIREBASE SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        let trades = [];
        let equityChartInstance = null; // Store Chart.js instance
        let currentEquity = 0; // Current account balance

        // DOM Elements
        const tradeLogBody = document.getElementById('trade-log-body');
        const kpiContainer = document.getElementById('kpi-container');
        const symbolFilter = document.getElementById('symbol-filter');
        const addTradeBtn = document.getElementById('add-trade-btn');
        const importDataBtn = document.getElementById('import-data-btn');
        const tradeModal = document.getElementById('trade-modal');
        const importModal = document.getElementById('import-modal');
        const tradeForm = document.getElementById('trade-form');
        const importForm = document.getElementById('import-form');
        const cancelTradeBtn = document.getElementById('cancel-trade-btn');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const importDataTextarea = document.getElementById('import-data-textarea');
        const importStatus = document.getElementById('import-status');
        const noTradesMessage = document.getElementById('no-trades-message');
        const tradeNotesInput = document.getElementById('trade-notes'); // Notes Field
        const mainContentGrid = document.getElementById('main-content-grid'); // Fixed reference

        
        // Equity Elements
        const equityModal = document.getElementById('equity-modal');
        const equityForm = document.getElementById('equity-form');
        const currentEquityInput = document.getElementById('current-equity');
        const cancelEquityBtn = document.getElementById('cancel-equity-btn');
        
        // New/Renamed Input Fields
        const tradeGrossPnLInput = document.getElementById('trade-gross-pnl');
        const tradeFeeInput = document.getElementById('trade-fee'); 

        let currentTradeToEdit = null;
        let confirmationTimeout = null;

        // Sample data for initial load
        const sampleTrades = [
            { date: '2025-10-12', symbol: 'NVDA', grossPnL: 150.00, size: 10, fee: 1.50, notes: 'Successful breakout trade, high conviction.' },
            { date: '2025-10-13', symbol: 'TSLA', grossPnL: -200.00, size: 5, fee: 2.00, notes: 'Emotional revenge trade after missing the morning rally.' },
            { date: '2025-10-14', symbol: 'AMD', grossPnL: 50.00, size: 20, fee: 0.80, notes: 'Scalp on 5-min chart, target hit perfectly.' },
            { date: '2025-10-15', symbol: 'NVDA', grossPnL: 250.00, size: 10, fee: 1.50, notes: 'Re-entry into NVDA, trend continuation trade.' },
            { date: '2025-10-16', symbol: 'TSLA', grossPnL: -100.00, size: 5, fee: 2.00, notes: 'Stop loss hit due to market volatility. System was followed.' },
            { date: '2025-10-17', symbol: 'GOOGL', grossPnL: 100.00, size: 2, fee: 0.50, notes: 'Earnings gap fill strategy. Held overnight.' }
        ];

        // --- UTILITY FUNCTIONS ---

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize Firestore.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // userId set here
                        console.log("User authenticated. UID:", userId);
                        startTradeListener(); // Listener starts here
                        startEquityListener(); // Start listening for equity
                        checkAndInsertSampleData(); // Check and insert sample data once authentication is ready
                    } else {
                        console.log("No user signed in. Using anonymous sign-in or falling back to default.");
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
            }
        }

        /**
         * Formats a number to currency string.
         * @param {number} amount - The number to format.
         * @param {boolean} includeColor - Whether to include color class.
         * @returns {string} The formatted currency string or text.
         */
        function formatCurrency(amount, includeColor = true) {
            const num = parseFloat(amount);
            const formatted = `$${Math.abs(num).toFixed(2)}`;
            
            if (includeColor) {
                const sign = num >= 0 ? '' : '-';
                const colorClass = num >= 0 ? 'green-text' : 'red-text';
                return `<span class="${colorClass}">${sign}${formatted}</span>`;
            }
            return formatted;
        }
        
        /**
         * Formats a factor or rate.
         * @param {number} value - The number to format.
         * @returns {string} The formatted factor or rate.
         */
        function formatFactor(value) {
            const num = parseFloat(value);
            const colorClass = num >= 1.0 ? 'green-text' : 'red-text';
            return `<span class="${colorClass}">${num.toFixed(2)}</span>`;
        }


        /**
         * Calculates and renders Key Performance Indicators (KPIs).
         * @param {Array<Object>} tradeData - Array of trade objects.
         */
        function renderKPIs(tradeData) {
            // Note: All PnL calculations use the NET P&L stored in the 'pnl' field.
            const winningTrades = tradeData.filter(trade => trade.pnl > 0);
            const losingTrades = tradeData.filter(trade => trade.pnl < 0);
            const grossProfit = winningTrades.reduce((sum, trade) => sum + trade.pnl, 0);
            const grossLoss = losingTrades.reduce((sum, trade) => sum + trade.pnl, 0); // This will be negative
            
            const totalPnL = grossProfit + grossLoss;
            const totalTrades = tradeData.length;
            const winRate = totalTrades > 0 ? (winningTrades.length / totalTrades) * 100 : 0;
            // const avgPnL = totalTrades > 0 ? totalPnL / totalTrades : 0; // Removed as it wasn't requested

            const avgWin = winningTrades.length > 0 ? grossProfit / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? grossLoss / losingTrades.length : 0; // Negative value
            
            // Profit Factor: Gross Profit / Absolute Gross Loss
            const profitFactor = Math.abs(grossLoss) > 0 ? grossProfit / Math.abs(grossLoss) : grossProfit > 0 ? Infinity : 0; 
            
            const largestWin = tradeData.length > 0 ? Math.max(...tradeData.map(t => t.pnl)) : 0;
            const largestLoss = tradeData.length > 0 ? Math.min(...tradeData.map(t => t.pnl)) : 0;
            
            const kpiMetrics = [
                { title: 'Total Net P&L', value: formatCurrency(totalPnL), color: totalPnL >= 0 ? 'green-text' : 'red-text' },
                { title: 'Total Trades', value: totalTrades, color: 'text-white' },
                { title: 'Win Rate', value: `${winRate.toFixed(1)}%`, color: winRate >= 50 ? 'green-text' : 'red-text' },
                { title: 'Profit Factor', value: formatFactor(profitFactor), color: profitFactor >= 1 ? 'green-text' : 'red-text' },
                { title: 'Avg. Winning Trade', value: formatCurrency(avgWin), color: 'green-text' }, 
                { title: 'Avg. Losing Trade', value: formatCurrency(avgLoss), color: 'red-text' }, 
                { title: 'Largest Win', value: formatCurrency(largestWin), color: 'green-text' },
                { title: 'Largest Loss', value: formatCurrency(largestLoss), color: 'red-text' }
            ];

            kpiContainer.innerHTML = kpiMetrics.map(metric => `
                <div class="p-2 border-b border-[#30363d] last:border-b-0">
                    <p class="kpi-title font-medium text-gray-400">${metric.title}</p>
                    <p class="kpi-value mt-1 ${metric.color}">${metric.value}</p>
                </div>
            `).join('');
            
            // Render the Equity Balance card 
            if (!document.getElementById('equity-balance-card')) {
                 const equityCardHTML = `
                    <div id="equity-balance-card" class="card p-5 rounded-lg lg:col-span-1 flex flex-col justify-center items-center">
                        <p class="text-sm font-medium text-gray-400 mb-1">Current Account Equity</p>
                        <p id="current-equity-display" class="kpi-value text-white">${formatCurrency(currentEquity, false)}</p>
                        <button id="update-equity-btn" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-200">
                            Update Equity
                        </button>
                    </div>
                `;
                
                // *** FIX: Insert the new card using the reliable ID "main-content-grid" ***
                if (mainContentGrid) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = equityCardHTML.trim();
                    const newCard = tempDiv.firstChild;
                    // The main content grid has 3 children: Chart, KPI, and the hidden Equity card element itself. 
                    // We insert the new card *before* the KPI container (index 1) to position it correctly.
                    mainContentGrid.insertBefore(newCard, mainContentGrid.children[1]); 
                }
            } else {
                document.getElementById('current-equity-display').innerHTML = formatCurrency(currentEquity, false);
            }
        }
        
        /**
         * Renders the Equity Curve Chart using Chart.js
         * @param {Array<Object>} tradeData - Array of trade objects.
         */
        function renderEquityCurve(tradeData) {
            // Sort trades chronologically for the curve
            const sortedTrades = [...tradeData].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

            const labels = [];
            const dataPoints = [];
            let cumulativePnL = 0;

            sortedTrades.forEach(trade => {
                cumulativePnL += trade.pnl; // Uses NET P&L
                labels.push(trade.date);
                dataPoints.push(cumulativePnL);
            });
            
            const ctx = document.getElementById('equity-curve-chart').getContext('2d');
            
            // Destroy previous chart instance if it exists
            if (equityChartInstance) {
                equityChartInstance.destroy();
            }

            equityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Net P&L ($)',
                        data: dataPoints,
                        borderColor: '#3fb950', // Green line color
                        backgroundColor: 'rgba(63, 185, 80, 0.2)',
                        borderWidth: 2,
                        pointRadius: 2,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Net P&L: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Trade Date', color: '#8b949e' },
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: { display: true, text: 'P&L ($)', color: '#8b949e' },
                            ticks: { 
                                color: '#8b949e',
                                callback: function(value) {
                                    return `$${value}`;
                                }
                            },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
        }


        /**
         * Renders the trade log table body based on the current trades and filter.
         */
        function renderTradeLog(currentTrades) {
            tradeLogBody.innerHTML = '';
            const selectedSymbol = symbolFilter.value;
            const filteredTrades = selectedSymbol === 'ALL'
                ? currentTrades
                : currentTrades.filter(trade => trade.symbol === selectedSymbol);

            if (filteredTrades.length === 0) {
                tradeLogBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No trades match the current filter.</td></tr>`;
                noTradesMessage.classList.remove('hidden');
            } else {
                filteredTrades.forEach(trade => {
                    const date = trade.date ? new Date(trade.date).toLocaleDateString() : 'N/A';
                    const notesPreview = trade.notes ? trade.notes.substring(0, 50) + (trade.notes.length > 50 ? '...' : '') : 'N/A';
                    const feeDisplay = trade.fee !== undefined ? trade.fee.toFixed(2) : '0.00'; // Display fee
                    
                    const row = document.createElement('tr');
                    row.className = 'data-row hover:bg-[#21262d] transition duration-150';
                    row.innerHTML = `
                        <td class="px-6 py-3 whitespace-nowrap">${date}</td>
                        <td class="px-6 py-3 whitespace-nowrap font-medium text-white">${trade.symbol}</td>
                        <td class="px-6 py-3 whitespace-nowrap">${formatCurrency(trade.pnl)}</td> <!-- Net P&L -->
                        <td class="px-6 py-3 whitespace-nowrap text-red-300">-$${feeDisplay}</td> <!-- Fee -->
                        <td class="px-6 py-3 whitespace-nowrap">${trade.size.toLocaleString()}</td>
                        <td class="px-6 py-3 whitespace-normal max-w-xs text-sm text-gray-400">${notesPreview}</td>
                        <td class="px-6 py-3 whitespace-nowrap space-x-2">
                            <button data-id="${trade.id}" class="edit-btn text-blue-400 hover:text-blue-300 font-semibold text-xs">Edit</button>
                            <button data-id="${trade.id}" class="delete-btn text-red-400 hover:text-red-300 font-semibold text-xs">Delete</button>
                        </td>
                    `;
                    tradeLogBody.appendChild(row);
                });
                noTradesMessage.classList.add('hidden');
            }
        }

        /**
         * Updates the symbol filter dropdown with unique symbols from trades.
         */
        function updateSymbolFilter(tradeData) {
            const uniqueSymbols = ['ALL', ...new Set(tradeData.map(trade => trade.symbol))];
            const currentFilter = symbolFilter.value;

            symbolFilter.innerHTML = uniqueSymbols.map(symbol =>
                `<option value="${symbol}" ${symbol === currentFilter ? 'selected' : ''}>${symbol}</option>`
            ).join('');
        }

        // --- FIRESTORE OPERATIONS ---

        const getTradesCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not logged in.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}
            return collection(db, `artifacts/${appId}/users/${userId}/trades`);
        };
        
        const getEquityDocRef = () => {
             if (!db || !userId) {
                console.error("Firestore not initialized or user not logged in.");
                return null;
            }
            // Private data path for a single document: /artifacts/{appId}/users/{userId}/settings/equity
            return doc(db, `artifacts/${appId}/users/${userId}/settings/equity`);
        };

        /**
         * Starts a real-time listener for trade data.
         */
        function startTradeListener() {
            const tradesRef = getTradesCollectionRef();
            if (!tradesRef) return;

            const q = query(tradesRef);

            onSnapshot(q, (snapshot) => {
                trades = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Handle potential old data without 'fee' or 'grossPnL' fields (legacy support)
                    const fee = parseFloat(data.fee || 0);
                    let netPnL = parseFloat(data.pnl || 0);

                    // If grossPnL exists, calculate net PnL from it. Otherwise, assume 'pnl' is already net.
                    const grossPnL = parseFloat(data.grossPnL || data.pnl || 0);
                    
                    if (data.grossPnL !== undefined) {
                         // Use saved grossPnL to calculate netPnL based on the saved fee
                         netPnL = grossPnL - fee; 
                    } 
                    // Ensure symbol is always uppercase for filtering
                    const symbol = (data.symbol || 'N/A').toUpperCase();

                    trades.push({
                        id: doc.id,
                        date: data.date,
                        symbol: symbol,
                        pnl: netPnL,          // This is the NET P&L used for all calculations
                        grossPnL: grossPnL,   // Original value before fees (for editing form)
                        fee: fee,             // Fee value
                        size: parseFloat(data.size || 0),
                        notes: data.notes || '', 
                        createdAt: data.createdAt ? data.createdAt.toDate().getTime() : 0,
                    });
                });

                // Sort trades by date (most recent first) in memory for the table
                const tableSortedTrades = [...trades].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

                // 1. Update Filter Options
                updateSymbolFilter(trades);

                // 2. Render KPIs (use all trades)
                renderKPIs(trades);
                
                // 3. Render Equity Curve (use all trades sorted chronologically)
                renderEquityCurve(trades);

                // 4. Render Trade Log (use table-sorted trades)
                renderTradeLog(tableSortedTrades);

            }, (error) => {
                console.error("Error listening to trade data:", error);
                tradeLogBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-400">Failed to load trades. Check console for error.</td></tr>`;
            });
        }
        
        /**
         * Starts a real-time listener for account equity data.
         */
        function startEquityListener() {
            const equityRef = getEquityDocRef();
            if (!equityRef) return;

            onSnapshot(equityRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentEquity = parseFloat(docSnap.data().balance || 0);
                } else {
                    currentEquity = 0; // Default if not set
                }
                
                // Rerender KPIs/Equity Card to reflect new balance
                renderKPIs(trades); 
            }, (error) => {
                console.error("Error listening to equity data:", error);
            });
        }


        /**
         * Adds a new trade document to Firestore.
         * @param {Object} tradeData - The trade data object (containing grossPnL and fee).
         */
        async function addTrade(tradeData) {
            const tradesRef = getTradesCollectionRef();
            if (!tradesRef) return;
            
            const grossPnL = parseFloat(tradeData.grossPnL);
            const fee = parseFloat(tradeData.fee || 0);
            const netPnL = grossPnL - fee;

            try {
                await addDoc(tradesRef, {
                    date: tradeData.date,
                    symbol: tradeData.symbol.toUpperCase(),
                    pnl: netPnL,        // Store the NET P&L (legacy field, kept for consistency)
                    grossPnL: grossPnL, // Store Gross P&L for audit/edit
                    fee: fee,           // Store Fee for audit/edit
                    size: parseFloat(tradeData.size),
                    notes: tradeData.notes || '',
                    createdAt: serverTimestamp(),
                });
                console.log("Trade added successfully.");
            } catch (error) {
                console.error("Error adding trade:", error);
            }
        }

        /**
         * Updates an existing trade document in Firestore.
         * @param {string} id - Document ID of the trade to update.
         * @param {Object} tradeData - The trade data object.
         */
        async function updateTrade(id, tradeData) {
            const tradesRef = getTradesCollectionRef();
            if (!tradesRef) return;

            const grossPnL = parseFloat(tradeData.grossPnL);
            const fee = parseFloat(tradeData.fee || 0);
            const netPnL = grossPnL - fee;
            
            try {
                const tradeDocRef = doc(tradesRef, id);
                await updateDoc(tradeDocRef, {
                    date: tradeData.date,
                    symbol: tradeData.symbol.toUpperCase(),
                    pnl: netPnL,
                    grossPnL: grossPnL,
                    fee: fee,
                    size: parseFloat(tradeData.size),
                    notes: tradeData.notes || '',
                });
                console.log("Trade updated successfully:", id);
            } catch (error) {
                console.error("Error updating trade:", error);
            }
        }

        /**
         * Deletes a trade document from Firestore.
         * @param {string} id - Document ID of the trade to delete.
         */
        async function deleteTrade(id) {
            const tradesRef = getTradesCollectionRef();
            if (!tradesRef) return;
            
            try {
                await deleteDoc(doc(tradesRef, id));
                console.log("Trade deleted successfully:", id);
            } catch (error) {
                console.error("Error deleting trade:", error);
            }
        }
        
        /**
         * Updates the account equity balance.
         * @param {number} balance - The new equity balance.
         */
        async function updateEquity(balance) {
            const equityRef = getEquityDocRef();
            if (!equityRef) return;

            try {
                await setDoc(equityRef, {
                    balance: parseFloat(balance),
                    updatedAt: serverTimestamp()
                });
                console.log("Equity updated successfully:", balance);
            } catch (error) {
                console.error("Error setting equity:", error);
            }
        }


        // --- BULK IMPORT LOGIC ---

        /**
         * Parses and saves bulk CSV data (YYYY-MM-DD,SYMBOL,Gross PnL,Size,Fee).
         */
        async function parseAndSaveBulkTrades(event) {
            event.preventDefault();
            const rawData = importDataTextarea.value.trim();
            const lines = rawData.split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) {
                importStatus.textContent = 'Paste data first.';
                return;
            }

            const tradesToBatch = [];
            let errorCount = 0;

            lines.forEach(line => {
                // Use a regex to split based on commas, but tolerate surrounding spaces
                const parts = line.split(',').map(p => p.trim());
                
                if (parts.length < 5) {
                    errorCount++;
                    console.warn(`Skipping line due to insufficient columns: ${line}`);
                    return;
                }
                
                // Extract and trim parts aggressively
                const date = parts[0].trim();
                const symbol = parts[1].trim();
                const grossPnLStr = parts[2].trim();
                const sizeStr = parts[3].trim();
                const feeStr = parts[4].trim();
                
                // Clean and parse values
                const grossPnL = parseFloat(grossPnLStr);
                const size = parseFloat(sizeStr);
                const fee = parseFloat(feeStr);
                
                // Basic validation
                if (!date || !symbol || isNaN(grossPnL) || isNaN(size) || isNaN(fee)) {
                    errorCount++;
                    console.warn(`Skipping line due to invalid data format: ${line}`);
                    return;
                }

                const netPnL = grossPnL - fee;

                tradesToBatch.push({
                    date,
                    symbol: symbol.toUpperCase(),
                    grossPnL,
                    fee,
                    size,
                    pnl: netPnL,
                    notes: 'Imported via Bulk Flex Report',
                    createdAt: serverTimestamp(),
                });
            });

            if (tradesToBatch.length > 0) {
                const tradesRef = getTradesCollectionRef();
                if (!tradesRef) return;
                
                const batch = writeBatch(db);
                tradesToBatch.forEach(trade => {
                    const newDocRef = doc(tradesRef); // Create a new doc reference with auto-generated ID
                    batch.set(newDocRef, trade);
                });

                try {
                    await batch.commit();
                    const successMessage = `Successfully imported ${tradesToBatch.length} trades.`;
                    importStatus.textContent = errorCount > 0 ? `${successMessage} (${errorCount} lines skipped due to error).` : successMessage;
                    importStatus.classList.remove('text-red-400');
                    importStatus.classList.add('green-text');
                    importDataTextarea.value = ''; // Clear text area on success
                    
                    // Close modal after a brief moment
                    setTimeout(() => {
                        importModal.classList.add('hidden');
                        // Reset status message after closing
                        importStatus.classList.remove('green-text');
                        importStatus.textContent = '';
                    }, 1500);

                } catch (error) {
                    console.error("Batch commit failed:", error);
                    importStatus.textContent = `Error saving data to Firestore: ${error.message}`;
                    importStatus.classList.add('text-red-400');
                }
            } else if (errorCount > 0) {
                 importStatus.textContent = `No trades imported. ${errorCount} lines skipped due to errors.`;
                 importStatus.classList.add('text-red-400');
            } else {
                 importStatus.textContent = 'No valid data lines found.';
                 importStatus.classList.add('text-red-400');
            }
        }


        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            // Handles filtering when the symbol selection changes.
            symbolFilter.addEventListener('change', () => {
                // Re-sort the trades to be table-sorted (most recent first)
                const tableSortedTrades = [...trades].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                renderTradeLog(tableSortedTrades);
            });
            
            // --- MODAL CONTROLS ---

            addTradeBtn.addEventListener('click', () => {
                currentTradeToEdit = null;
                document.getElementById('modal-title').textContent = 'Add New Trade';
                tradeForm.reset();
                // Initialize input values to avoid 'null' issues
                tradeGrossPnLInput.value = '';
                tradeFeeInput.value = '0.00';
                tradeNotesInput.value = '';
                tradeModal.classList.remove('hidden');
            });
            
            importDataBtn.addEventListener('click', () => {
                importStatus.textContent = ''; // Clear any previous status
                importDataTextarea.value = ''; // Ensure textarea is empty
                importModal.classList.remove('hidden');
            });
            
            // Listener for the newly rendered Update Equity button
            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'update-equity-btn') {
                    currentEquityInput.value = currentEquity.toFixed(2);
                    equityModal.classList.remove('hidden');
                }
            });


            [cancelTradeBtn, cancelImportBtn, cancelEquityBtn].forEach(btn => {
                btn.addEventListener('click', () => {
                    tradeModal.classList.add('hidden');
                    importModal.classList.add('hidden');
                    equityModal.classList.add('hidden');
                    
                    if (confirmationTimeout) {
                        clearTimeout(confirmationTimeout);
                    }
                });
            });


            // --- FORM SUBMISSIONS ---

            tradeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const tradeData = {
                    date: document.getElementById('trade-date').value,
                    symbol: document.getElementById('trade-symbol').value,
                    grossPnL: parseFloat(tradeGrossPnLInput.value),
                    fee: parseFloat(tradeFeeInput.value || 0),
                    size: parseFloat(document.getElementById('trade-size').value),
                    notes: tradeNotesInput.value,
                };

                if (currentTradeToEdit) {
                    await updateTrade(currentTradeToEdit.id, tradeData);
                } else {
                    await addTrade(tradeData);
                }

                tradeModal.classList.add('hidden');
            });

            importForm.addEventListener('submit', parseAndSaveBulkTrades);
            
            equityForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const balance = parseFloat(currentEquityInput.value);
                if (!isNaN(balance)) {
                    await updateEquity(balance);
                    equityModal.classList.add('hidden');
                }
            });


            // --- DYNAMIC BUTTON LISTENERS (EDIT/DELETE) ---

            tradeLogBody.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (!id) return;

                if (e.target.classList.contains('edit-btn')) {
                    const trade = trades.find(t => t.id === id);
                    if (trade) {
                        currentTradeToEdit = trade;
                        document.getElementById('modal-title').textContent = `Edit Trade: ${trade.symbol}`;
                        
                        document.getElementById('trade-date').value = trade.date || '';
                        document.getElementById('trade-symbol').value = trade.symbol || '';
                        tradeGrossPnLInput.value = trade.grossPnL !== undefined ? trade.grossPnL.toFixed(2) : '';
                        tradeFeeInput.value = trade.fee !== undefined ? trade.fee.toFixed(2) : '0.00';
                        document.getElementById('trade-size').value = trade.size !== undefined ? trade.size : '';
                        tradeNotesInput.value = trade.notes || '';

                        tradeModal.classList.remove('hidden');
                    }
                } else if (e.target.classList.contains('delete-btn')) {
                    // Double-click confirmation logic
                    const btn = e.target;
                    
                    if (btn.dataset.confirm === 'true') {
                        deleteTrade(id);
                        btn.dataset.confirm = 'false';
                        if (confirmationTimeout) clearTimeout(confirmationTimeout);
                    } else {
                        btn.textContent = 'Confirm?';
                        btn.classList.remove('text-red-400');
                        btn.classList.add('text-red-600', 'font-bold');
                        btn.dataset.confirm = 'true';
                        
                        // Set timeout to revert the button after 3 seconds
                        confirmationTimeout = setTimeout(() => {
                            btn.textContent = 'Delete';
                            btn.classList.add('text-red-400');
                            btn.classList.remove('text-red-600', 'font-bold');
                            btn.dataset.confirm = 'false';
                        }, 3000);
                    }
                }
            });
            
            // Stop double-click/confirm reset if user clicks elsewhere
            document.addEventListener('click', (e) => {
                if (confirmationTimeout && !e.target.classList.contains('delete-btn')) {
                    const activeBtn = document.querySelector('.delete-btn[data-confirm="true"]');
                    if (activeBtn) {
                         activeBtn.textContent = 'Delete';
                         activeBtn.classList.add('text-red-400');
                         activeBtn.classList.remove('text-red-600', 'font-bold');
                         activeBtn.dataset.confirm = 'false';
                    }
                    clearTimeout(confirmationTimeout);
                    confirmationTimeout = null;
                }
            });
        });

        // --- SAMPLE DATA INSERTION ---

        async function checkAndInsertSampleData() {
            const tradesRef = getTradesCollectionRef();
            if (!tradesRef) return;
            
            try {
                // Check if any trades exist for this user
                const snapshot = await getDocs(tradesRef);
                
                if (snapshot.empty) {
                    console.log("No trades found. Inserting sample data.");
                    const batch = writeBatch(db);
                    
                    sampleTrades.forEach(trade => {
                        const newDocRef = doc(tradesRef); 
                        const netPnL = trade.grossPnL - trade.fee;
                        
                        batch.set(newDocRef, {
                            date: trade.date,
                            symbol: trade.symbol.toUpperCase(),
                            grossPnL: trade.grossPnL,
                            fee: trade.fee,
                            size: trade.size,
                            pnl: netPnL,
                            notes: trade.notes,
                            createdAt: serverTimestamp(),
                        });
                    });
                    
                    // Insert sample equity balance
                    const equityRef = getEquityDocRef();
                    batch.set(equityRef, {
                        balance: 10000.00,
                        updatedAt: serverTimestamp()
                    });

                    await batch.commit();
                    console.log("Sample data inserted successfully.");
                } else {
                    console.log(`Found ${snapshot.size} existing trades. Skipping sample data insertion.`);
                }
            } catch (error) {
                console.error("Error inserting sample data:", error);
            }
        }
        
    </script>
</body>
</html>
