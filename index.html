<!-- Chosen Palette: Midnight Blue & Gold -->
<!-- Application Structure Plan: A top-down dashboard architecture prioritizing stability and clarity. The primary control is the Account Selector, which acts as a global filter for all data. Below this, a secondary control panel allows users to filter by Time Period and Symbol. The main content area features a large Equity Curve chart for visual trend analysis, a set of dynamic KPI cards for at-a-glance performance metrics (including Account Equity), and a detailed, interactive Trade Log for journaling and review. All interactions (adding/importing/editing trades, creating accounts) are handled through non-blocking modals. This structure provides a logical user flow: select a portfolio, filter the view, analyze performance from macro to micro level. -->
<!-- Visualization & Content Choices: 
- Goal: Manage separate trading strategies -> Presentation: Dropdown Account Selector (HTML) -> Interaction: Changing selection triggers a full data reload for the chosen account's trades and equity.
- Goal: Analyze performance over time -> Presentation: Dropdown Time Period Filter (HTML) -> Interaction: Re-filters the current account's data and re-renders all charts and KPIs.
- Goal: Visualize account growth -> Presentation: Equity Curve Line Chart (Chart.js Canvas) -> Interaction: Updates dynamically with all filters; tooltips show cumulative P&L.
- Goal: Summarize performance -> Presentation: KPI Cards (HTML/CSS) -> Interaction: All metrics (P&L, Win Rate, Profit Factor, Avg Win/Loss) are recalculated instantly based on filtered data.
- Goal: Log and review trades -> Presentation: Interactive Data Table (HTML) -> Interaction: Users can add, edit, or delete trades via modals. The table updates to reflect the current data filters.
- All data entry and editing is handled through modals to provide a focused, error-resistant user experience. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Performance Dashboard & Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .card { background-color: #161b22; border: 1px solid #30363d; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .kpi-value { font-size: 1.5rem; line-height: 1.75rem; font-weight: 700; }
        .kpi-title { font-size: 0.8rem; }
        .green-text { color: #3fb950; }
        .red-text { color: #f85149; }
        .data-row:nth-child(even) { background-color: #1e242b; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #484f58; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5c6370; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold mb-6 text-white border-b border-[#30363d] pb-3">Trade Performance Dashboard & Journal</h1>

        <div class="card p-4 mb-6 rounded-lg text-sm bg-yellow-900/30 border-yellow-700/50">
            <p class="font-semibold text-yellow-300">‚ö†Ô∏è Data & Hosting Strategy:</p>
            <p class="text-yellow-400">This app uses Firebase Firestore for secure, permanent data storage. For stable hosting, deploy this file to **Firebase Hosting** or **Netlify**, as GitHub Pages can cause conflicts.</p>
        </div>
        
        <div class="mb-6 flex items-center gap-4">
            <label for="account-selector" class="text-sm font-medium">Select Portfolio/Account:</label>
            <select id="account-selector" class="p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white focus:ring-blue-500 focus:border-blue-500 w-48"></select>
            <button id="add-account-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-xs font-bold py-2 px-3 rounded-lg transition duration-200">+ New Account</button>
        </div>

        <div id="main-content-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card p-5 rounded-lg lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4 text-white">Equity Curve (Cumulative P&L)</h2>
                <div class="chart-container relative h-64 md:h-80"><canvas id="equity-curve-chart"></canvas></div>
            </div>
            <div id="kpi-parent-card" class="card p-5 rounded-lg lg:col-span-1">
                <h2 class="text-xl font-semibold mb-4 text-white">Core Metrics</h2>
                <div id="kpi-container" class="grid grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div class="card p-6 rounded-lg">
            <h2 class="text-2xl font-semibold mb-4 text-white">Trade Log & Journal</h2>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex gap-4">
                    <div>
                        <label for="time-period-filter" class="block text-sm font-medium mb-1">Time Period:</label>
                        <select id="time-period-filter" class="w-full sm:w-48 p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white">
                            <option value="ALL">All Time</option>
                            <option value="YTD">Year-to-Date</option>
                            <option value="LAST_90D">Last 90 Days</option>
                            <option value="LAST_30D">Last 30 Days</option>
                            <option value="THIS_YEAR">This Year</option>
                        </select>
                    </div>
                    <div>
                        <label for="symbol-filter" class="block text-sm font-medium mb-1">Filter by Symbol:</label>
                        <select id="symbol-filter" class="w-full sm:w-48 p-2 rounded-lg bg-[#0d1117] border border-[#30363d] text-white">
                            <option value="ALL">ALL SYMBOLS</option>
                        </select>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button id="import-data-btn" class="w-full sm:w-auto bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">üìÑ Import Bulk Data</button>
                    <button id="add-trade-btn" class="w-full sm:w-auto bg-[#3fb950] hover:bg-[#289d3a] text-white font-bold py-2 px-4 rounded-lg">+ Add New Trade</button>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg border border-[#30363d]">
                <table id="trade-table" class="min-w-full divide-y divide-[#30363d]">
                    <thead class="bg-[#21262d]">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Symbol</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Net P&L ($)</th> 
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Fee ($)</th> 
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Size</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Notes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="trade-log-body" class="divide-y divide-[#30363d] text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals (all hidden by default) -->
    <div id="trade-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg p-6 rounded-xl">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-white">Add New Trade</h3>
            <form id="trade-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2"><label for="trade-date" class="block text-sm font-medium">Date Closed</label><input type="date" id="trade-date" required class="w-full p-2 mt-1 rounded-lg bg-[#0d1117] border border-[#30363d]"></div>
                    <div><label for="trade-symbol" class="block text-sm font-medium">Symbol</label><input type="text" id="trade-symbol" required class="w-full p-2 mt-1 rounded-lg bg-[#0d1117] border border-[#30363d] uppercase"></div>
                    <div><label for="trade-size" class="block text-sm font-medium">Position Size</label><input type="text" id="trade-size" required class="w-full p-2 mt-1 rounded-lg bg-[#0d1117] border border-[#30363d]"></div>
                    <div><label for="trade-gross-pnl" class="block text-sm font-medium">Gross P&L ($)</label><input type="text" id="trade-gross-pnl" required class="w-full p-2 mt-1 rounded-lg bg-[#0d1117] border border-[#30363d]"></div>
                    <div><label for="trade-fee" class="block text-sm font-medium">Commission Fee ($)</label><input type="text" id="trade-fee" value="0.00" class="w-full p-2 mt-1 rounded-lg bg-[#0d1117] border border-[#30363d]"></div>
                </div>
                <div class="mt-4"><label for="trade-notes" class="block text-sm font-medium">Journal/Notes</label><textarea id="trade-notes" rows="3" class="w-full p-2 mt-1 rounded-lg bg-[#0d1117] border border-[#30363d] resize-none"></textarea></div>
                <div class="flex justify-end space-x-3 pt-4 mt-2">
                    <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Save Trade</button>
                </div>
            </form>
        </div>
    </div>
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-lg p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4">Import Trades (CSV)</h3>
            <p class="text-sm text-gray-400 mb-4">Paste data below. Format: <code class="bg-[#30363d] p-1 rounded">YYYY-MM-DD,SYMBOL,Gross PnL,Size,Fee</code></p>
            <form id="import-form">
                <textarea id="import-data-textarea" rows="10" class="w-full p-3 rounded-lg bg-[#0d1117] border border-[#30363d] resize-none"></textarea>
                <div id="import-status" class="text-sm mt-2 font-medium"></div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 font-bold py-2 px-4 rounded-lg">Process & Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="equity-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-sm p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4">Update Equity for <span id="equity-modal-account-name"></span></h3>
            <form id="equity-form">
                <div><label for="current-equity" class="block text-sm font-medium mb-1">Current Balance ($)</label><input type="text" id="current-equity" required class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d]"></div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Save Balance</button>
                </div>
            </form>
        </div>
    </div>
    <div id="new-account-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-sm p-6 rounded-xl">
            <h3 class="text-xl font-bold mb-4">Add New Portfolio Account</h3>
            <form id="new-account-form">
                <div><label for="new-account-name" class="block text-sm font-medium mb-1">Account Name/ID</label><input type="text" id="new-account-name" required class="w-full p-2 rounded-lg bg-[#0d1117] border border-[#30363d]" maxlength="20"></div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" class="cancel-btn bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, updateDoc, deleteDoc, serverTimestamp, writeBatch, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Variables (Defined at the top for scope access)
        let db, auth, userId;
        let appId, firebaseConfig, initialAuthToken; 

        let trades = [], accounts = [];
        let equityChartInstance;
        let currentAccountId = '', currentEquity = 0;
        
        const dom = {
            accountSelector: document.getElementById('account-selector'),
            tradeLogBody: document.getElementById('trade-log-body'),
            kpiContainer: document.getElementById('kpi-container'),
            symbolFilter: document.getElementById('symbol-filter'),
            timePeriodFilter: document.getElementById('time-period-filter'),
            tradeModal: document.getElementById('trade-modal'),
            importModal: document.getElementById('import-modal'),
            equityModal: document.getElementById('equity-modal'),
            newAccountModal: document.getElementById('new-account-modal'),
            tradeForm: document.getElementById('trade-form'),
            importForm: document.getElementById('import-form'),
            equityForm: document.getElementById('equity-form'),
            newAccountForm: document.getElementById('new-account-form'),
            mainContentGrid: document.getElementById('main-content-grid'),
            kpiParentCard: document.getElementById('kpi-parent-card'),
        };

        const formatCurrency = (amount, color = true) => {
            const num = parseFloat(amount) || 0;
            const sign = num < 0 ? '-' : '';
            const formatted = `$${Math.abs(num).toFixed(2)}`;
            if (!color) return `${sign}${formatted}`;
            const colorClass = num >= 0 ? 'green-text' : 'red-text';
            return `<span class="${colorClass}">${sign}${formatted}</span>`;
        };

        const getFilterStartDate = () => {
            const val = dom.timePeriodFilter.value;
            const now = new Date();
            if (val === 'YTD' || val === 'THIS_YEAR') return new Date(now.getFullYear(), 0, 1);
            if (val === 'LAST_90D') return new Date(now.setDate(now.getDate() - 90));
            if (val === 'LAST_30D') return new Date(now.setDate(now.getDate() - 30));
            return new Date(0);
        };

        const filterTrades = (allTrades) => {
            const startDate = getFilterStartDate();
            const symbol = dom.symbolFilter.value;
            return allTrades.filter(t => new Date(t.date) >= startDate && (symbol === 'ALL' || t.symbol === symbol));
        };

        const renderAllComponents = () => {
            const filteredForKpis = filterTrades(trades, false);
            const filteredForTable = filterTrades(trades);
            renderKPIs(filteredForKpis);
            renderEquityCurve(filteredForKpis);
            renderTradeLog(filteredForTable);
            updateSymbolFilter(trades);
        };

        const renderKPIs = (tradeData) => {
            const wins = tradeData.filter(t => t.pnl > 0);
            const losses = tradeData.filter(t => t.pnl < 0);
            const grossProfit = wins.reduce((sum, t) => sum + t.pnl, 0);
            const grossLoss = losses.reduce((sum, t) => sum + t.pnl, 0);
            const profitFactor = Math.abs(grossLoss) > 0 ? grossProfit / Math.abs(grossLoss) : grossProfit > 0 ? Infinity : 0;

            const metrics = [
                { title: 'Total Net P&L', value: formatCurrency(grossProfit + grossLoss) },
                { title: 'Total Trades', value: tradeData.length, color: 'text-white' },
                { title: 'Win Rate', value: `${(tradeData.length > 0 ? wins.length / tradeData.length * 100 : 0).toFixed(1)}%` },
                { title: 'Profit Factor', value: profitFactor.toFixed(2) },
                { title: 'Avg. Win', value: formatCurrency(wins.length > 0 ? grossProfit / wins.length : 0) },
                { title: 'Avg. Loss', value: formatCurrency(losses.length > 0 ? grossLoss / losses.length : 0) },
            ];
            dom.kpiContainer.innerHTML = metrics.map(m => `<div><p class="kpi-title text-gray-400">${m.title}</p><p class="kpi-value ${m.color || ''}">${m.value}</p></div>`).join('');
            
            if (!document.getElementById('equity-balance-card')) {
                const cardHTML = `<div id="equity-balance-card" class="card p-5 rounded-lg flex flex-col justify-center items-center"><p id="equity-card-title" class="text-sm font-medium text-gray-400 mb-1"></p><p id="current-equity-display" class="kpi-value"></p><button id="update-equity-btn" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Update</button></div>`;
                dom.mainContentGrid.insertBefore(document.createRange().createContextualFragment(cardHTML), dom.kpiParentCard);
            }
            const accountName = accounts.find(a => a.id === currentAccountId)?.name || '...';
            document.getElementById('equity-card-title').textContent = `Current Equity (${accountName})`;
            document.getElementById('current-equity-display').textContent = formatCurrency(currentEquity, false);
        };

        const renderEquityCurve = (tradeData) => {
            const sorted = [...tradeData].sort((a, b) => new Date(a.date) - new Date(b.date));
            let cumulativePnl = 0;
            const dataPoints = sorted.map(t => {
                cumulativePnl += t.pnl;
                return { x: t.date, y: cumulativePnl };
            });

            const ctx = document.getElementById('equity-curve-chart').getContext('2d');
            if (equityChartInstance) equityChartInstance.destroy();
            equityChartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: 'Cumulative Net P&L', data: dataPoints, borderColor: '#3fb950', tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } }, y: { ticks: { color: '#8b949e', callback: val => `$${val}` }, grid: { color: '#30363d' } } } }
            });
        };

        const renderTradeLog = (tradeData) => {
            dom.tradeLogBody.innerHTML = tradeData.sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => `
                <tr class="data-row hover:bg-[#21262d]">
                    <td class="px-6 py-3">${t.date}</td>
                    <td class="px-6 py-3 font-medium">${t.symbol}</td>
                    <td class="px-6 py-3">${formatCurrency(t.pnl)}</td>
                    <td class="px-6 py-3 text-red-300">-$${(t.fee || 0).toFixed(2)}</td>
                    <td class="px-6 py-3">${t.size}</td>
                    <td class="px-6 py-3 text-sm text-gray-400 max-w-xs truncate">${t.notes || ''}</td>
                    <td class="px-6 py-3"><button data-id="${t.id}" class="edit-btn text-blue-400 text-xs font-semibold">Edit</button> <button data-id="${t.id}" class="delete-btn text-red-400 text-xs font-semibold">Delete</button></td>
                </tr>`).join('');
        };
        
        const updateSymbolFilter = (tradeData) => {
            const symbols = ['ALL', ...new Set(tradeData.map(t => t.symbol))];
            dom.symbolFilter.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
        };

        const getCollectionRef = (name) => collection(db, `artifacts/${appId}/users/${userId}/${name}`);
        const getEquityDocRef = () => doc(db, `artifacts/${appId}/users/${userId}/equity_balances/${currentAccountId}`);

        const startAccountListener = () => onSnapshot(getCollectionRef('accounts'), snapshot => {
            accounts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            if (accounts.length === 0) { addAccount('Default Account'); return; }
            const currentIsValid = accounts.some(a => a.id === currentAccountId);
            currentAccountId = currentIsValid ? currentAccountId : accounts[0].id;
            dom.accountSelector.innerHTML = accounts.map(a => `<option value="${a.id}" ${a.id === currentAccountId ? 'selected' : ''}>${a.name}</option>`).join('');
            startDataListeners();
        });

        const startDataListeners = () => {
            if (!currentAccountId) return;
            onSnapshot(getEquityDocRef(), doc => {
                currentEquity = doc.exists() ? doc.data().balance : 0;
                renderAllComponents();
            });
            onSnapshot(query(getCollectionRef('trades')), snapshot => {
                trades = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(t => t.accountId === currentAccountId);
                renderAllComponents();
            });
        };

        const addAccount = async (name) => {
            const newDocRef = await addDoc(getCollectionRef('accounts'), { name, createdAt: serverTimestamp() });
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/equity_balances/${newDocRef.id}`), { balance: 0 });
        };
        
        const saveTrade = (id, data) => id ? updateDoc(doc(getCollectionRef('trades'), id), data) : addDoc(getCollectionRef('trades'), { ...data, accountId: currentAccountId, createdAt: serverTimestamp() });
        const deleteTrade = id => deleteDoc(doc(getCollectionRef('trades'), id));
        const updateEquity = balance => setDoc(getEquityDocRef(), { balance });

        const resetAndEnableInputs = (form) => {
            form.reset();
            form.querySelectorAll('input, textarea').forEach(el => el.removeAttribute('disabled'));
        };

        const attachEventListeners = () => {
            let editId = null;

            document.getElementById('add-account-btn').addEventListener('click', () => {
                resetAndEnableInputs(dom.newAccountForm);
                dom.newAccountModal.classList.remove('hidden');
            });
            document.getElementById('add-trade-btn').addEventListener('click', () => {
                editId = null;
                resetAndEnableInputs(dom.tradeForm);
                dom.tradeModal.querySelector('h3').textContent = 'Add New Trade';
                dom.tradeModal.classList.remove('hidden');
            });
            document.getElementById('import-data-btn').addEventListener('click', () => dom.importModal.classList.remove('hidden'));
            
            document.body.addEventListener('click', e => {
                if (e.target.id === 'update-equity-btn') {
                    dom.equityForm.querySelector('input').value = currentEquity.toFixed(2);
                    dom.equityModal.classList.remove('hidden');
                }
                if (e.target.classList.contains('edit-btn')) {
                    editId = e.target.dataset.id;
                    const trade = trades.find(t => t.id === editId);
                    if (!trade) return;
                    resetAndEnableInputs(dom.tradeForm);
                    dom.tradeModal.querySelector('h3').textContent = `Edit Trade: ${trade.symbol}`;
                    Object.keys(trade).forEach(key => {
                        const el = dom.tradeForm.querySelector(`#trade-${key.replace('grossPnL', 'gross-pnl')}`);
                        if (el) el.value = trade[key];
                    });
                    dom.tradeModal.classList.remove('hidden');
                }
                if (e.target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this trade?')) deleteTrade(e.target.dataset.id);
                }
            });

            dom.accountSelector.addEventListener('change', () => { currentAccountId = dom.accountSelector.value; startDataListeners(); });
            dom.symbolFilter.addEventListener('change', renderAllComponents);
            dom.timePeriodFilter.addEventListener('change', renderAllComponents);
            
            document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => {
                dom.tradeModal.classList.add('hidden');
                dom.importModal.classList.add('hidden');
                dom.equityModal.classList.add('hidden');
                dom.newAccountModal.classList.add('hidden');
            }));

            dom.newAccountForm.addEventListener('submit', e => {
                e.preventDefault();
                const name = dom.newAccountForm.querySelector('input').value.trim();
                if (name) { addAccount(name); dom.newAccountModal.classList.add('hidden'); }
            });

            dom.tradeForm.addEventListener('submit', e => {
                e.preventDefault();
                const grossPnL = parseFloat(document.getElementById('trade-gross-pnl').value);
                const fee = parseFloat(document.getElementById('trade-fee').value);
                const data = {
                    date: document.getElementById('trade-date').value,
                    symbol: document.getElementById('trade-symbol').value.toUpperCase(),
                    size: parseFloat(document.getElementById('trade-size').value),
                    grossPnL, fee,
                    pnl: grossPnL - fee,
                    notes: document.getElementById('trade-notes').value,
                };
                saveTrade(editId, data);
                dom.tradeModal.classList.add('hidden');
            });

            dom.importForm.addEventListener('submit', async e => {
                e.preventDefault();
                const lines = document.getElementById('import-data-textarea').value.trim().split('\n');
                const batch = writeBatch(db);
                lines.forEach(line => {
                    const [date, symbol, grossPnlStr, sizeStr, feeStr] = line.split(/,\s*/);
                    const grossPnL = parseFloat(grossPnlStr), fee = parseFloat(feeStr);
                    if (date && symbol && !isNaN(grossPnL) && !isNaN(fee)) {
                        const newDocRef = doc(getCollectionRef('trades'));
                        batch.set(newDocRef, { date, symbol: symbol.toUpperCase(), size: parseFloat(sizeStr), grossPnL, fee, pnl: grossPnL - fee, accountId: currentAccountId, notes: 'Bulk Import' });
                    }
                });
                await batch.commit();
                dom.importModal.classList.add('hidden');
            });
            
            dom.equityForm.addEventListener('submit', e => {
                e.preventDefault();
                updateEquity(parseFloat(document.getElementById('current-equity').value));
                dom.equityModal.classList.add('hidden');
            });
        };

        const startApp = async () => { 
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (Object.keys(firebaseConfig).length === 0) return console.error("Firebase config is empty.");
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    startAccountListener();
                    attachEventListeners();
                }
            });

            try {
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        };

        document.addEventListener('DOMContentLoaded', startApp); // Corrected function call
    </script>
</body>
</html>
